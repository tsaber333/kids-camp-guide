<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foursquare Kids Camp - Interactive Leader's Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-container { position: relative; width: 100%; max-width: 350px; margin-left: auto; margin-right: auto; height: 350px; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .card-enter {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        .card-enter-active {
            opacity: 1;
            transform: translateY(0);
        }
        /* Custom scrollbar for modals */
        .modal-content-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .modal-content-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .modal-content-scroll::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .modal-content-scroll::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-800">

    <div id="app-container" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-teal-700">Foursquare Kids Camp</h1>
            <p class="mt-4 text-lg text-stone-600">Interactive Leader's Guide</p>
            <div id="user-id-display" class="mt-2 text-sm text-stone-500"></div>
        </header>

        <main>
            <section id="dashboard" class="mb-12">
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 items-center">
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                        <h2 class="text-2xl font-bold text-teal-700 mb-2">Welcome, Camp Leaders!</h2>
                        <p class="text-stone-600">
                            This guide is your central hub for planning and leading activities. Use the filters below to quickly find the perfect game for your next slot, whether you're on the field or need an indoor option for a rainy day. Each game card provides a full breakdown of instructions, materials, and key discussion points to connect with our camp's mission.
                        </p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                        <h3 class="text-xl font-bold text-center text-teal-700 mb-4">Activity Overview</h3>
                        <div class="chart-container" style="height: 150px; max-width: 150px;">
                            <canvas id="activityTypeChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <section id="leader-resources" class="mb-12 bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                <h2 class="text-2xl font-bold text-teal-700 mb-4">Leader Resources & Best Practices</h2>
                <p class="text-stone-600 mb-4">
                    This section provides essential guidance to help you make the most of this interactive guide and ensure a successful, safe, and spiritually impactful activity time for your campers.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-xl font-bold text-teal-700 mb-2">Navigating This Guide</h3>
                        <ul class="list-disc list-inside text-stone-700 space-y-2">
                            <li><strong>Filtering Activities:</strong> Use the "Filter by Type," "Filter by Location," and "Filter by Materials" to quickly narrow down game options. Select "All" to see the full list again.</li>
                            <li><strong>Viewing Details:</strong> Click on any activity card to open a detailed modal. This modal contains objectives, step-by-step instructions, a comprehensive materials list, crucial safety notes, and the "SuperCharged Application."</li>
                            <li><strong>Material Check:</strong> Always review the "Materials Needed" section well in advance of your activity time to ensure all supplies are readily available.</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-teal-700 mb-2">Leading Activities Effectively</h3>
                        <ul class="list-disc list-inside text-stone-700 space-y-2">
                            <li><strong>Safety First:</strong> Prioritize the "Safety Notes" for each game. Conduct a quick safety check of the play area and equipment before starting.</li>
                            <li><strong>Clear Instructions:</strong> Explain game rules clearly and concisely. Demonstrate if possible. Encourage questions before starting.</li>
                            <li><strong>Adapt & Modify:</strong> Feel free to adapt games to suit your group's size, age, energy levels, or available space.</li>
                            <li><strong>Encourage Participation:</strong> Create an inclusive environment where every camper feels comfortable participating and trying their best.</li>
                            <li><strong>Time Management:</strong> Keep an eye on the clock to ensure you have enough time for the activity itself and, crucially, for the debriefing.</li>
                        </ul>
                    </div>
                    <div class="md:col-span-2">
                        <h3 class="text-xl font-bold text-teal-700 mb-2">Maximizing the "SuperCharged Application"</h3>
                        <p class="text-stone-700">
                            The "SuperCharged Application" is key to connecting our activities with the spiritual growth of our campers. This section provides prompts and ideas to help you facilitate meaningful discussions after each game.
                        </p>
                        <ul class="list-disc list-inside text-stone-700 space-y-2 mt-2">
                            <li><strong>Purpose:</strong> This is where we bridge the fun of the game to life lessons and Foursquare values.</li>
                            <li><strong>Timing:</strong> Always debrief immediately after the game, while the experience is fresh in their minds.</li>
                            <li><strong>Open-Ended Questions:</strong> Use the suggested questions as a starting point. Encourage honest sharing and active listening among campers.</li>
                            <li><strong>Connect to Scripture/Values:</strong> Help campers see how the game's lessons relate to Bible principles or the Foursquare values (e.g., 'Jesus the Savior, Healer, Baptizer with the Holy Spirit, and Soon-Coming King').</li>
                            <li><strong>Personal Reflection:</strong> Encourage campers to think about how they can apply these lessons in their daily lives.</li>
                        </ul>
                    </div>
                </div>
            </section>
            
            <section id="activity-finder">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-200 mb-8">
                    <h2 class="text-2xl font-bold text-teal-700 mb-4">Find an Activity</h2>
                    <div class="flex flex-wrap gap-4 items-center">
                        <div>
                            <label class="font-bold text-stone-700">Filter by Type:</label>
                            <div id="type-filters" class="flex flex-wrap gap-2 mt-2">
                                <button class="filter-btn-type bg-teal-600 text-white py-2 px-4 rounded-full" data-type="all">All</button>
                                <button class="filter-btn-type bg-stone-200 text-stone-700 py-2 px-4 rounded-full" data-type="Field Game">Field Games</button>
                                <button class="filter-btn-type bg-stone-200 text-stone-700 py-2 px-4 rounded-full" data-type="Team Time">Team Time</button>
                            </div>
                        </div>
                         <div>
                            <label class="font-bold text-stone-700">Filter by Location:</label>
                            <div id="location-filters" class="flex flex-wrap gap-2 mt-2">
                                <button class="filter-btn-location bg-teal-600 text-white py-2 px-4 rounded-full" data-location="all">All</button>
                                <button class="filter-btn-location bg-stone-200 text-stone-700 py-2 px-4 rounded-full" data-location="Outdoor">Outdoor</button>
                                <button class="filter-btn-location bg-stone-200 text-stone-700 py-2 px-4 rounded-full" data-location="Indoor">Indoor</button>
                                <button class="filter-btn-location bg-stone-200 text-stone-700 py-2 px-4 rounded-full" data-location="Both">Both</button>
                            </div>
                        </div>
                        <div>
                            <label for="material-filter-select" class="font-bold text-stone-700">Filter by Material:</label>
                            <select id="material-filter-select" class="mt-2 block w-full pl-3 pr-10 py-2 text-base border-stone-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm rounded-md">
                                <option value="all">All Materials</option>
                                <!-- Options will be dynamically populated here -->
                            </select>
                        </div>
                    </div>
                </div>

                <div id="game-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div id="loading-indicator" class="col-span-full text-center text-stone-500 text-lg py-8">Loading activities...</div>
                </div>
            </section>
        </main>
    </div>

    <!-- Game Details Modal -->
    <div id="game-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto modal-content-scroll">
            <div class="sticky top-0 bg-white p-4 sm:p-6 border-b border-stone-200 flex justify-between items-center">
                <h2 id="modal-title" class="text-2xl sm:text-3xl font-bold text-teal-700"></h2>
                <button id="close-modal" class="text-stone-500 hover:text-red-600 transition-colors">
                    <span class="text-2xl font-bold">&times;</span>
                </button>
            </div>
            <div id="modal-content" class="p-4 sm:p-6">
            </div>
        </div>
    </div>

    <!-- Add Activity Modal -->
    <div id="add-activity-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto modal-content-scroll">
            <div class="sticky top-0 bg-white p-4 sm:p-6 border-b border-stone-200 flex justify-between items-center">
                <h2 class="text-2xl sm:text-3xl font-bold text-teal-700">Add New Activity</h2>
                <button id="close-add-activity-modal" class="text-stone-500 hover:text-red-600 transition-colors">
                    <span class="text-2xl font-bold">&times;</span>
                </button>
            </div>
            <form id="add-activity-form" class="p-4 sm:p-6 space-y-6">
                <div>
                    <label for="activity-name" class="block text-stone-700 font-bold mb-2">Activity Name <span class="text-red-500">*</span></label>
                    <input type="text" id="activity-name" name="name" required class="w-full p-3 border border-stone-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                </div>

                <div>
                    <label class="block text-stone-700 font-bold mb-2">Activity Type <span class="text-red-500">*</span></label>
                    <div class="flex flex-wrap gap-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="type" value="Field Game" class="form-radio text-teal-600" required>
                            <span class="ml-2 text-stone-700">Field Game</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="type" value="Team Time" class="form-radio text-teal-600">
                            <span class="ml-2 text-stone-700">Team Time</span>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-stone-700 font-bold mb-2">Location <span class="text-red-500">*</span></label>
                    <div class="flex flex-wrap gap-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="location" value="Outdoor" class="form-radio text-teal-600" required>
                            <span class="ml-2 text-stone-700">Outdoor</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="location" value="Indoor" class="form-radio text-teal-600">
                            <span class="ml-2 text-stone-700">Indoor</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="location" value="Both" class="form-radio text-teal-600">
                            <span class="ml-2 text-stone-700">Both</span>
                        </label>
                    </div>
                </div>

                <div>
                    <label for="objectives" class="block text-stone-700 font-bold mb-2">Objectives <span class="text-red-500">*</span></label>
                    <textarea id="objectives" name="objectives" rows="3" required class="w-full p-3 border border-stone-300 rounded-md focus:ring-teal-500 focus:border-teal-500"></textarea>
                </div>

                <div>
                    <label class="block text-stone-700 font-bold mb-2">Instructions <span class="text-red-500">*</span></label>
                    <div id="instructions-container" class="space-y-3">
                        <div class="instruction-item flex items-center gap-2">
                            <textarea name="instructions[]" rows="2" required class="w-full p-3 border border-stone-300 rounded-md focus:ring-teal-500 focus:border-teal-500" placeholder="e.g., Setup: Divide a large outdoor field..."></textarea>
                            <button type="button" class="remove-instruction-btn text-red-500 hover:text-red-700 text-xl font-bold">&times;</button>
                        </div>
                    </div>
                    <button type="button" id="add-instruction-btn" class="mt-3 bg-stone-200 text-stone-700 py-2 px-4 rounded-md hover:bg-stone-300 transition-colors">Add Instruction Step</button>
                </div>

                <div>
                    <label class="block text-stone-700 font-bold mb-2">Materials Needed</label>
                    <div id="materials-container" class="space-y-3">
                        <div class="material-item flex items-center gap-2">
                            <input type="text" name="materials[]" class="w-full p-3 border border-stone-300 rounded-md focus:ring-teal-500 focus:border-teal-500" placeholder="e.g., Water Guns (14)">
                            <button type="button" class="remove-material-btn text-red-500 hover:text-red-700 text-xl font-bold">&times;</button>
                        </div>
                    </div>
                    <button type="button" id="add-material-btn" class="mt-3 bg-stone-200 text-stone-700 py-2 px-4 rounded-md hover:bg-stone-300 transition-colors">Add Material</button>
                </div>

                <div>
                    <label for="safety-notes" class="block text-stone-700 font-bold mb-2">Safety Notes <span class="text-red-500">*</span></label>
                    <textarea id="safety-notes" name="safety" rows="3" required class="w-full p-3 border border-stone-300 rounded-md focus:ring-teal-500 focus:border-teal-500"></textarea>
                </div>

                <div>
                    <label for="supercharged-app" class="block text-stone-700 font-bold mb-2">SuperCharged Application <span class="text-red-500">*</span></label>
                    <textarea id="supercharged-app" name="supercharged" rows="3" required class="w-full p-3 border border-stone-300 rounded-md focus:ring-teal-500 focus:border-teal-500"></textarea>
                </div>

                <div class="flex justify-end">
                    <button type="submit" class="bg-teal-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-teal-700 transition-colors">Add Activity</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables
        let app;
        let db;
        let auth;
        let userId;

        // IMPORTANT: Replace this with your actual Firebase config for GitHub Pages deployment.
        // Go to your Firebase project settings -> General -> Your apps -> Web app -> Firebase SDK snippet -> Config
// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyCNMLCw5f1ajmGLHP9gnfzojcryUIufs6E",
  authDomain: "kids-camp-guide.firebaseapp.com",
  projectId: "kids-camp-guide",
  storageBucket: "kids-camp-guide.firebasestorage.app",
  messagingSenderId: "774110400277",
  appId: "1:774110400277:web:7e3b65313073e3aacf631c",
  measurementId: "G-LL8SZ9NW8L"
};
        // For GitHub Pages, __app_id and __initial_auth_token are not automatically provided.
        // The appId for Firestore collection path will be derived from firebaseConfig.appId
        // or default to 'default-app-id' if not found.
        const appId = firebaseConfig.appId || 'default-app-id';


        // Initial games data - these will be loaded first, then merged with user-added data from Firestore
        const initialGamesData = [
            {
                id: 'game1',
                name: 'Balloon Defying Gravity',
                type: 'Field Game',
                location: 'Both',
                objectives: 'Keep a balloon from touching the ground for a full minute using any body part except hands. Enhances coordination, speed, and quick thinking.',
                instructions: [
                    'The object of this game is to keep the balloon from touching the ground for a full minute.',
                    'Players may use any body part, but cannot hold it in their hands.',
                    'The balloon must continually be moving.',
                    'For a challenge, try only allowing one hand, or no hands at all, or add in more than one balloon.',
                    'For younger kids, keeping one balloon from touching the ground for a full minute will be a challenge enough!',
                    'If multiple people are playing at the same time, use balloons in different colors so players don\'t get confused.'
                ],
                materials: ['Balloons (various colors)'],
                safety: 'Ensure adequate space to prevent collisions. Be mindful of allergies if using latex balloons.',
                supercharged: 'Discussion: How do we keep our faith "afloat" and prevent it from "touching the ground" when challenges arise? What "body parts" (spiritual disciplines) can we use to keep it moving?'
            },
            {
                id: 'game2',
                name: 'Stack \'Em Up',
                type: 'Team Time',
                location: 'Indoor',
                objectives: 'Stack 36 plastic cups into a pyramid and unstack them back into a single tower within one minute.',
                instructions: [
                    'Each player gets 36 plastic cups.',
                    'The object is to stack all 36 into a pyramid and unstack them back into a single tower before the minute is up.',
                    'If playing with teams, it might be easier to play several rounds rather than trying to stack them together.'
                ],
                materials: ['Plastic cups (36 per player/team)'],
                safety: 'Ensure a stable surface for stacking. Supervise younger children to prevent cups from being thrown or stepped on.',
                supercharged: 'Discussion: How does teamwork help us build something great, even under time pressure? What "foundations" do we need in our lives to build strong character?'
            },
            {
                id: 'game3',
                name: 'Sponge Run',
                type: 'Field Game',
                location: 'Outdoor',
                objectives: 'Teams race to transport water using sponges on their heads, filling a bucket at the other end of the yard.',
                instructions: [
                    'Place a kiddie pool filled with water on one side of the yard and an empty bucket on the other.',
                    'Players soak a sponge in the kiddie pool.',
                    'Run across the yard with the wet sponge balanced on their heads.',
                    'Dump the water from the sponge into the empty bucket.',
                    'The team whose bucket has the most water at the end of the timer wins.'
                ],
                materials: ['Kiddie pool (1)', 'Empty buckets (1 per team)', 'Sponges (assorted, multiple per team)'],
                safety: 'Ensure the running path is clear of obstacles. Be mindful of slippery surfaces around water. Hydrate participants.',
                supercharged: 'Discussion: This game requires careful balance and perseverance. How can we "carry" God\'s message to others, even when it feels challenging or requires us to be careful and persistent?'
            },
            {
                id: 'game4',
                name: 'Rubber Band Shooting Gallery',
                type: 'Field Game',
                location: 'Both',
                objectives: 'Fling rubber bands to knock down as many soda cans as possible from 10 feet away within one minute.',
                instructions: [
                    'Set up old soda cans (or other light objects) as targets.',
                    'Players stand 10 feet away from the targets.',
                    'Compete to fling rubber bands and knock down as many cans as possible in one minute.'
                ],
                materials: ['Rubber bands (various thicknesses)', 'Old soda cans (or plastic bottles)'],
                safety: 'Ensure clear firing lines and no one is standing in the path of the rubber bands or targets. Emphasize aiming at cans only, not people.',
                supercharged: 'Discussion: Sometimes we have to aim carefully and keep trying to hit our "targets" in life. What are some spiritual "targets" we are aiming for, and how can we practice to hit them?'
            },
            {
                id: 'game5',
                name: 'Catapult Challenge',
                type: 'Team Time',
                location: 'Both',
                objectives: 'Build and compete in various challenges with built catapults (projectile distance, fastest time to fill a container, knock object over).',
                instructions: [
                    'Teams are given a box of random items (e.g., popsicle sticks, rubber bands, caps/cups).',
                    'Teams must design and build a catapult using only the provided materials.',
                    'Once built, compete in challenges: projectile distance, fastest time to fill a container with projectiles, or knocking an object over.'
                ],
                materials: ['Popsicle sticks', 'Rubber bands (various thicknesses)', 'Caps/cups for projectile bucket', 'Various projectiles (clay, cotton balls, paper clips)', 'Box of random items for building'],
                safety: 'Supervise the building process to prevent injuries from tools or sharp edges. Ensure projectiles are soft and safe. Establish clear firing zones.',
                supercharged: 'Discussion: This challenge requires creativity and problem-solving. How can we use the "tools" God has given us (our talents, gifts) to build things that impact the world for Him?'
            },
            {
                id: 'game6',
                name: 'Minefield',
                type: 'Field Game',
                location: 'Outdoor',
                objectives: 'Navigate a "minefield" blindfolded with verbal guidance from teammates.',
                instructions: [
                    'Set up 20-30 cones and 15-20 soft objects (e.g., small balls, bean bags) to create obstacles and "mines" within a defined field.',
                    'Establish clear start and finish lines.',
                    'One player is blindfolded and must navigate the minefield.',
                    'Teammates provide verbal instructions to guide the blindfolded player through the field, avoiding "mines".',
                    'If a player touches a mine, they go back to the start (or the last safe point).',
                    'The winning team is the one whose members successfully navigate the minefield first.'
                ],
                materials: ['Cones (20-30)', 'Soft objects (15-20, e.g., small balls, bean bags)', 'Whistles (2, to signal a hit)', 'Blindfolds (1 per player/team)', 'Something to mark start/finish lines'],
                safety: 'Ensure the minefield is free of actual hazards. Use soft objects only. Clear communication is key to prevent collisions. Have spotters for safety.',
                supercharged: 'Discussion: This game highlights the importance of trust and clear communication. How do we trust in God\'s guidance when we can\'t see the path ahead? How important is listening to wise counsel from others in our spiritual journey?'
            },
            {
                id: 'game7',
                name: 'Photo Scavenger Hunt',
                type: 'Team Time',
                location: 'Both',
                objectives: 'Teams find and take photos of items, places, or poses listed on a scavenger hunt sheet.',
                instructions: [
                    'Provide each team with a Photo Scavenger Hunt sheet listing items, places, or poses to photograph.',
                    'One team leader uses their phone to take photos (campers do not need phones).',
                    'As photos are taken, cross them off the list.',
                    'Once all photos are taken, return to the starting area and upload them to a provided Google Drive link.',
                    'Photos will be reviewed together at the end of Team Time.'
                ],
                materials: ['Photo Scavenger Hunt sheets (pre-prepared)', 'Pens/pencils', 'Team leader\'s smartphone (for photos)', 'Google Drive link (provided by activity leader)'],
                safety: 'Ensure safe areas for the scavenger hunt. Remind participants to stay together as a team. Emphasize respectful behavior in all locations.',
                supercharged: 'Discussion: Finding hidden items requires observation and collaboration. What "treasures" can we find in God\'s Word when we diligently search for them? How does working together help us achieve a common goal?'
            },
            {
                id: 'game8',
                name: 'Charades Relay',
                type: 'Team Time',
                location: 'Indoor',
                objectives: 'Teams act out prompts for their teammates to guess in a relay format.',
                instructions: [
                    'Teams line up single-file in a half-circle shape.',
                    'Assign one team leader to tally points (needs paper and pen).',
                    'The first person in line runs to a bucket and picks up a slip of paper with a prompt.',
                    'Participants must take the first prompt they read (no "fishing" unless they\'ve never heard of it).',
                    'The person returns to their group and acts out the prompt without speaking or mouthing words.',
                    'Teammates guess and yell out the prompt as quickly as they can.',
                    'Once guessed, the leader tallies a point, and the actor goes to the end of the line.',
                    'The next person immediately runs to collect another prompt.',
                    'Game ends once all prompts are taken from the bucket. Leaders tally total points.'
                ],
                materials: ['Slips of paper with prompts (pre-written)', 'Bucket', 'Paper and pen (for scorekeeping)'],
                safety: 'Ensure clear space for acting. Remind participants to be respectful and encouraging.',
                supercharged: 'Discussion: Communication is key even without words. How can we "act out" our faith in ways that others can understand, even without speaking? What does it mean to live a life that speaks louder than words?'
            },
            {
                id: 'game9',
                name: 'Frisbee Target Toss',
                type: 'Field Game',
                location: 'Outdoor',
                objectives: 'Toss frisbees into hula hoops at different distances for varying points.',
                instructions: [
                    'Set up hula hoops at different distances from a throwing line.',
                    'Assign different point values to each hula hoop based on difficulty (e.g., further hoops are worth more).',
                    'Players take 3 frisbees and toss them, aiming for the hula hoops.',
                    'Score points based on where the frisbees land inside the hoops.'
                ],
                materials: ['Frisbees (multiple per player/team)', 'Hula hoops (various sizes/colors)', 'Cones or tape for throwing line'],
                safety: 'Ensure a wide, clear throwing area. Be mindful of other people and objects in the vicinity. Use soft frisbees if possible.',
                supercharged: 'Discussion: Hitting a target requires focus and practice. What are some "targets" God calls us to aim for in our lives, and how do we practice to get better at hitting them?'
            },
            {
                id: 'game10',
                name: 'Nerf Targets',
                type: 'Field Game',
                location: 'Both',
                objectives: 'Shoot Nerf guns to knock down mini water cups set up as targets.',
                instructions: [
                    'Set up 200 mini water cups to create targets (e.g., stacked in pyramids or lines).',
                    'Players use Nerf guns and bullets to shoot at the targets.',
                    'The goal is to knock down as many cups as possible within a set time or with a set number of bullets.'
                ],
                materials: ['Mini water cups (200)', 'Nerf gun bullets (70+)', 'Nerf guns (2 or more)'],
                safety: 'Establish clear firing lines and target zones. Emphasize never aiming at people. Collect bullets regularly to prevent tripping hazards.',
                supercharged: 'Discussion: Sometimes we face many "obstacles" or "challenges" in life, like these cups. How can we, with God\'s help, "take aim" at our challenges and overcome them?'
            }
        ];

        // This variable will hold all activities, including initial and user-added ones.
        let allActivities = [];
        let activityTypeChart; // Declare chart variable globally

        document.addEventListener('DOMContentLoaded', async () => {
            const gameGrid = document.getElementById('game-grid');
            const modal = document.getElementById('game-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const closeModalBtn = document.getElementById('close-modal');
            const typeFilters = document.getElementById('type-filters');
            const locationFilters = document.getElementById('location-filters');
            const materialFilterSelect = document.getElementById('material-filter-select');
            const addActivityModal = document.getElementById('add-activity-modal');
            const closeAddActivityModalBtn = document.getElementById('close-add-activity-modal');
            const addActivityForm = document.getElementById('add-activity-form');
            const instructionsContainer = document.getElementById('instructions-container');
            const addInstructionBtn = document.getElementById('add-instruction-btn');
            const materialsContainer = document.getElementById('materials-container');
            const addMaterialBtn = document.getElementById('add-material-btn');
            const loadingIndicator = document.getElementById('loading-indicator');
            const userIdDisplay = document.getElementById('user-id-display');

            let currentFilters = { type: 'all', location: 'all', material: 'all' };

            // Initialize Firebase
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate user
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        // Sign in anonymously if no user is authenticated
                        try {
                            // __initial_auth_token is provided by Canvas environment, not by GitHub Pages.
                            // So, if running on GitHub Pages, it will be undefined, and we sign in anonymously.
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                                userId = auth.currentUser.uid;
                            } else {
                                await signInAnonymously(auth);
                                userId = auth.currentUser.uid;
                            }
                        } catch (error) {
                            console.error("Firebase authentication failed, falling back to random UUID:", error);
                            // Fallback to a random UUID if authentication fails or is not applicable
                            userId = crypto.randomUUID();
                        }
                    }
                    userIdDisplay.textContent = `User ID: ${userId}`;
                    console.log("Firebase initialized. User ID:", userId);
                    // Start listening for activities only after auth is ready
                    listenForActivities();
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                loadingIndicator.textContent = "Error loading activities. Please ensure Firebase config is correct.";
                // Fallback to a random UUID if Firebase init fails
                userId = crypto.randomUUID();
                userIdDisplay.textContent = `User ID: ${userId} (Offline Mode)`;
                // If Firebase fails to initialize, we can still show initial games
                allActivities = [...initialGamesData];
                renderGames();
                populateMaterialFilter();
                updateActivityChart();
            }

            // Function to listen for real-time activity updates from Firestore
            function listenForActivities() {
                if (!db || !userId) {
                    console.warn("Firestore or User ID not ready for listening.");
                    // If Firestore isn't ready, just display the initial games.
                    allActivities = [...initialGamesData];
                    renderGames();
                    populateMaterialFilter();
                    updateActivityChart();
                    return;
                }
                const activitiesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/activities`);
                const q = query(activitiesCollectionRef);

                onSnapshot(q, (snapshot) => {
                    loadingIndicator.style.display = 'none'; // Hide loading indicator once data starts coming
                    const fetchedGames = [];
                    snapshot.forEach(doc => {
                        fetchedGames.push({ id: doc.id, ...doc.data() });
                    });
                    // Merge initial games with fetched games, prioritizing fetched games by ID if duplicates exist
                    const mergedGamesMap = new Map();
                    initialGamesData.forEach(game => mergedGamesMap.set(game.id, game));
                    fetchedGames.forEach(game => mergedGamesMap.set(game.id, game));
                    
                    allActivities = Array.from(mergedGamesMap.values());
                    renderGames();
                    populateMaterialFilter();
                    updateActivityChart();
                    console.log("Activities updated from Firestore (merged with initial data):", allActivities);
                }, (error) => {
                    console.error("Error fetching activities from Firestore:", error);
                    loadingIndicator.textContent = "Failed to load user activities. Displaying initial games.";
                    // Fallback to initial games if Firestore fetch fails
                    allActivities = [...initialGamesData];
                    renderGames();
                    populateMaterialFilter();
                    updateActivityChart();
                });
            }

            function getUniqueMaterials() {
                const allMaterials = new Set();
                allActivities.forEach(game => {
                    if (game.materials && Array.isArray(game.materials)) {
                        game.materials.forEach(material => {
                            const normalizedMaterial = material.split('(')[0].trim();
                            if (normalizedMaterial) { // Ensure material is not empty
                                allMaterials.add(normalizedMaterial);
                            }
                        });
                    }
                });
                return Array.from(allMaterials).sort();
            }

            function populateMaterialFilter() {
                const uniqueMaterials = getUniqueMaterials();
                materialFilterSelect.innerHTML = '<option value="all">All Materials</option>';
                uniqueMaterials.forEach(material => {
                    const option = document.createElement('option');
                    option.value = material;
                    option.textContent = material;
                    materialFilterSelect.appendChild(option);
                });
            }

            function renderGames() {
                gameGrid.innerHTML = '';
                
                // Add the "Add New Activity" card first
                const addActivityCard = document.createElement('div');
                addActivityCard.className = 'bg-emerald-100 rounded-xl shadow-sm border border-emerald-300 p-6 cursor-pointer hover:shadow-lg hover:-translate-y-1 transition-all duration-300 flex flex-col items-center justify-center text-center h-48'; // Fixed height for consistency
                addActivityCard.id = 'add-activity-card';
                addActivityCard.innerHTML = `
                    <div class="text-emerald-700 text-6xl mb-4">+</div>
                    <h3 class="text-xl font-bold text-emerald-700">Add New Activity</h3>
                    <p class="text-emerald-600 text-sm mt-2">Create a custom activity for your camp!</p>
                `;
                gameGrid.appendChild(addActivityCard);

                if (allActivities.length === 0 && loadingIndicator.style.display === 'none') {
                    // If no other activities, the "Add New Activity" card will be the only one visible initially
                    // No need for a "No activities found" message here as the add card serves that purpose.
                }

                const filteredGames = allActivities.filter(game => {
                    const typeMatch = currentFilters.type === 'all' || game.type === currentFilters.type;
                    const locationMatch = currentFilters.location === 'all' || game.location === currentFilters.location || game.location === 'Both';
                    
                    let materialMatch = true;
                    if (currentFilters.material !== 'all') {
                        materialMatch = game.materials && Array.isArray(game.materials) && game.materials.some(material => 
                            material.split('(')[0].trim() === currentFilters.material
                        );
                    }
                    
                    return typeMatch && locationMatch && materialMatch;
                });

                filteredGames.forEach((game) => {
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-xl shadow-sm border border-stone-200 p-6 cursor-pointer hover:shadow-lg hover:-translate-y-1 transition-all duration-300 flex flex-col';
                    card.dataset.gameId = game.id;
                    
                    const typeColor = game.type === 'Field Game' ? 'bg-sky-100 text-sky-800' : 'bg-amber-100 text-amber-800';
                    const locationIcon = game.location === 'Outdoor' ? '☀️' : game.location === 'Indoor' ? '🏠' : '☀️/🏠';

                    card.innerHTML = `
                        <div class="flex-grow">
                            <div class="flex justify-between items-start mb-3">
                                <span class="text-xs font-bold py-1 px-3 rounded-full ${typeColor}">${game.type || 'N/A'}</span>
                                <span class="text-xl">${locationIcon}</span>
                            </div>
                            <h3 class="text-xl font-bold text-teal-700 mb-2">${game.name || 'Untitled Activity'}</h3>
                            <p class="text-stone-600 text-sm">${game.description || (game.objectives ? game.objectives.substring(0, 100) + '...' : 'No description available.')}</p>
                        </div>
                        <button class="mt-4 w-full bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700 transition-colors">View Details</button>
                    `;
                    gameGrid.appendChild(card);
                    
                    requestAnimationFrame(() => {
                        card.classList.add('card-enter');
                        requestAnimationFrame(() => {
                            card.classList.add('card-enter-active');
                        });
                    });
                });
            }

            function showGameDetails(gameId) {
                const game = allActivities.find(g => g.id == gameId);
                if (!game) return;

                modalTitle.textContent = game.name || 'Activity Details';
                
                let materialsHTML = game.materials && Array.isArray(game.materials) && game.materials.length > 0 ? game.materials.map(item => `<li class="bg-stone-100 py-1 px-3 rounded-md">${item}</li>`).join('') : '<p class="text-stone-700">No specific materials listed.</p>';
                
                let instructionsContent = '';

                // Prioritize generalInstructions, then fallback to instructions
                const instructionsToRender = game.generalInstructions && Array.isArray(game.generalInstructions) && game.generalInstructions.length > 0
                    ? game.generalInstructions
                    : (game.instructions && Array.isArray(game.instructions) && game.instructions.length > 0 ? game.instructions : []);

                if (instructionsToRender.length > 0) {
                    instructionsContent += `
                        <div>
                            <h4 class="text-lg font-bold text-teal-700 mb-2">⚙️ Instructions</h4>
                            <ol class="list-decimal list-inside space-y-2 text-stone-700">
                                ${instructionsToRender.map(step => `<li>${step}</li>`).join('')}
                            </ol>
                        </div>
                    `;
                } else {
                    instructionsContent += `<div><h4 class="text-lg font-bold text-teal-700 mb-2">⚙️ Instructions</h4><p class="text-stone-700">No instructions available.</p></div>`;
                }

                // Render station-specific instructions if available (assuming this might be in some future data)
                if (game.stationInstructions && Array.isArray(game.stationInstructions) && game.stationInstructions.length > 0) {
                    instructionsContent += `
                        <div class="mt-6">
                            <h4 class="text-lg font-bold text-teal-700 mb-2">Stations Breakdown</h4>
                            <div class="space-y-4">
                                ${game.stationInstructions.map(station => `
                                    <div class="bg-stone-50 p-4 rounded-lg border border-stone-200">
                                        <h5 class="text-md font-semibold text-teal-600 mb-2">${station.title || 'Untitled Station'}</h5>
                                        ${station.content || '<p class="text-stone-700">No content for this station.</p>'}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                modalContent.innerHTML = `
                    <div class="space-y-6">
                        <div>
                            <h4 class="text-lg font-bold text-teal-700 mb-2">🎯 Objectives</h4>
                            <p class="text-stone-700">${game.objectives || 'No objectives listed.'}</p>
                        </div>
                        ${instructionsContent}
                         <div>
                            <h4 class="text-lg font-bold text-teal-700 mb-2">📦 Materials Needed</h4>
                            <ul class="flex flex-wrap gap-2 text-sm text-stone-800">
                                ${materialsHTML}
                            </ul>
                        </div>
                        <div>
                            <h4 class="text-lg font-bold text-teal-700 mb-2">⚠️ Safety Notes</h4>
                            <p class="text-stone-700">${game.safety || 'No safety notes listed.'}</p>
                        </div>
                        <div>
                            <h4 class="text-lg font-bold text-teal-700 mb-2">⚡ SuperCharged Application</h4>
                            <p class="text-stone-700 italic">${game.supercharged || 'No SuperCharged application listed.'}</p>
                        </div>
                    </div>
                `;
                modal.classList.add('active');
            }

            // Event listener for the game grid, including the new "Add Activity" card
            gameGrid.addEventListener('click', (e) => {
                const addCard = e.target.closest('#add-activity-card');
                if (addCard) {
                    addActivityModal.classList.add('active');
                    addActivityForm.reset(); // Clear form on open
                    // Ensure at least one instruction and material field is present
                    instructionsContainer.innerHTML = `
                        <div class="instruction-item flex items-center gap-2">
                            <textarea name="instructions[]" rows="2" required class="w-full p-3 border border-stone-300 rounded-md focus:ring-teal-500 focus:border-teal-500" placeholder="e.g., Setup: Divide a large outdoor field..."></textarea>
                            <button type="button" class="remove-instruction-btn text-red-500 hover:text-red-700 text-xl font-bold">&times;</button>
                        </div>
                    `;
                    materialsContainer.innerHTML = `
                        <div class="material-item flex items-center gap-2">
                            <input type="text" name="materials[]" class="w-full p-3 border border-stone-300 rounded-md focus:ring-teal-500 focus:border-teal-500" placeholder="e.g., Water Guns (14)">
                            <button type="button" class="remove-material-btn text-red-500 hover:text-red-700 text-xl font-bold">&times;</button>
                        </div>
                    `;
                    addRemoveEventListeners(); // Re-add listeners for new fields
                } else {
                    const card = e.target.closest('[data-game-id]');
                    if (card) {
                        showGameDetails(card.dataset.gameId);
                    }
                }
            });

            closeModalBtn.addEventListener('click', () => modal.classList.remove('active'));
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });

            function handleFilterClick(e, filterType) {
                 if (e.target.tagName !== 'BUTTON') return;

                const value = e.target.dataset[filterType];
                currentFilters[filterType] = value;

                const filterGroup = e.target.parentElement;
                filterGroup.querySelectorAll('button').forEach(btn => {
                    btn.classList.remove('bg-teal-600', 'text-white');
                    btn.classList.add('bg-stone-200', 'text-stone-700');
                });
                e.target.classList.add('bg-teal-600', 'text-white');
                e.target.classList.remove('bg-stone-200', 'text-stone-700');
                
                renderGames();
            }

            typeFilters.addEventListener('click', (e) => handleFilterClick(e, 'type'));
            locationFilters.addEventListener('click', (e) => handleFilterClick(e, 'location'));
            
            materialFilterSelect.addEventListener('change', (e) => {
                currentFilters.material = e.target.value;
                renderGames();
            });

            function updateActivityChart() {
                const fieldGameCount = allActivities.filter(g => g.type === 'Field Game').length;
                const teamTimeCount = allActivities.filter(g => g.type === 'Team Time').length;

                if (activityTypeChart) {
                    activityTypeChart.data.datasets[0].data = [fieldGameCount, teamTimeCount];
                    activityTypeChart.update();
                } else {
                    const ctx = document.getElementById('activityTypeChart').getContext('2d');
                    activityTypeChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Field Games', 'Team Time'],
                            datasets: [{
                                label: 'Activity Types',
                                data: [fieldGameCount, teamTimeCount],
                                backgroundColor: [
                                    'rgb(14 116 144)', // teal-700
                                    'rgb(217 119 6)'   // amber-600
                                ],
                                borderColor: [
                                    '#ffffff',
                                    '#ffffff'
                                ],
                                borderWidth: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        font: {
                                            family: 'Inter',
                                            size: 14,
                                        },
                                        color: '#44403c' // stone-700
                                    }
                                }
                            },
                            cutout: '60%'
                        }
                    });
                }
            }
            
            // --- Add Activity Modal Logic ---
            closeAddActivityModalBtn.addEventListener('click', () => addActivityModal.classList.remove('active'));
            addActivityModal.addEventListener('click', (e) => {
                if (e.target === addActivityModal) {
                    addActivityModal.classList.remove('active');
                }
            });

            function addInstructionField() {
                const div = document.createElement('div');
                div.className = 'instruction-item flex items-center gap-2';
                div.innerHTML = `
                    <textarea name="instructions[]" rows="2" required class="w-full p-3 border border-stone-300 rounded-md focus:ring-teal-500 focus:border-teal-500" placeholder="e.g., Setup: Divide a large outdoor field..."></textarea>
                    <button type="button" class="remove-instruction-btn text-red-500 hover:text-red-700 text-xl font-bold">&times;</button>
                `;
                instructionsContainer.appendChild(div);
                addRemoveEventListeners(); // Re-add listeners after adding new elements
            }

            function addMaterialField() {
                const div = document.createElement('div');
                div.className = 'material-item flex items-center gap-2';
                div.innerHTML = `
                    <input type="text" name="materials[]" class="w-full p-3 border border-stone-300 rounded-md focus:ring-teal-500 focus:border-teal-500" placeholder="e.g., Water Guns (14)">
                    <button type="button" class="remove-material-btn text-red-500 hover:text-red-700 text-xl font-bold">&times;</button>
                `;
                materialsContainer.appendChild(div);
                addRemoveEventListeners(); // Re-add listeners after adding new elements
            }

            function addRemoveEventListeners() {
                document.querySelectorAll('.remove-instruction-btn').forEach(button => {
                    button.onclick = (e) => {
                        if (instructionsContainer.children.length > 1) { // Ensure at least one field remains
                            e.target.closest('.instruction-item').remove();
                        }
                    };
                });
                document.querySelectorAll('.remove-material-btn').forEach(button => {
                    button.onclick = (e) => {
                        if (materialsContainer.children.length > 1) { // Ensure at least one field remains
                            e.target.closest('.material-item').remove();
                        }
                    };
                });
            }

            addInstructionBtn.addEventListener('click', addInstructionField);
            addMaterialBtn.addEventListener('click', addMaterialField);
            addRemoveEventListeners(); // Initial call for existing fields

            addActivityForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const formData = new FormData(e.target);
                const newActivity = {
                    name: formData.get('name'),
                    type: formData.get('type'),
                    location: formData.get('location'),
                    objectives: formData.get('objectives'),
                    safety: formData.get('safety'),
                    supercharged: formData.get('supercharged'),
                    // Get all instruction and material values
                    instructions: Array.from(document.querySelectorAll('#instructions-container textarea[name="instructions[]"]')).map(el => el.value).filter(val => val.trim() !== ''),
                    materials: Array.from(document.querySelectorAll('#materials-container input[name="materials[]"]')).map(el => el.value).filter(val => val.trim() !== ''),
                    description: formData.get('objectives').substring(0, 100) + '...' // Use objectives as description snippet
                };

                // Basic validation
                if (!newActivity.name || !newActivity.type || !newActivity.location || !newActivity.objectives || !newActivity.safety || !newActivity.supercharged || newActivity.instructions.length === 0) {
                    console.error("Please fill in all required fields (marked with *).");
                    // In a real app, you'd show a user-friendly message here.
                    return;
                }

                try {
                    if (db && userId) {
                        const docRef = await addDoc(collection(db, `artifacts/${appId}/users/${userId}/activities`), newActivity);
                        console.log("Document written with ID: ", docRef.id);
                        addActivityModal.classList.remove('active');
                        addActivityForm.reset();
                        // The onSnapshot listener will automatically update the UI
                    } else {
                        console.error("Firestore not initialized or user not authenticated. Activity not saved.");
                        // Optionally, add the activity to the local array if Firestore is not available
                        // This would mean it won't persist, but will appear for the current session.
                        // For this request, we prioritize persistence, so we won't add to local array if save fails.
                    }
                } catch (error) {
                    console.error("Error adding document to Firestore: ", error);
                    // In a real app, you'd show an error message to the user
                }
            });

            // Initial render and chart update (will be updated by onSnapshot once data loads)
            // If Firebase fails to initialize, these will use initialGamesData
            // Otherwise, onSnapshot will trigger the first render after fetching user data.
            if (!app) { // Only render initial games if Firebase failed to initialize
                renderGames();
                populateMaterialFilter();
                updateActivityChart();
            }
        });
    </script>
</body>
</html>
